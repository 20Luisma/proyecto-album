<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Clean Marvel Album ‚Äî √Ålbumes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    :root { --marvel:#ED1D24; --ink:#0b0d17; --line-w:4px; }
    body{font-family:'Roboto',sans-serif;background-color:var(--ink);}
    h1,h2,h3{font-family:'Bangers',cursive;letter-spacing:1.5px}

    /* HERO superior */
    .app-hero{
      position:relative;
      background: radial-gradient(1200px 400px at 10% -10%, rgba(255,255,255,.08), transparent 60%),
                  linear-gradient(180deg, #151826 0%, #0b0d17 100%);
      border-bottom: var(--line-w) solid var(--marvel);
      border-top: var(--line-w) solid var(--marvel);
    }
    .app-hero__inner{max-width:80rem;margin:0 auto;padding:2.25rem 1rem;display:flex;flex-direction:column;gap:.5rem}
    .app-hero__title{color:#fff;font-size:2.25rem;line-height:1}
    .app-hero__meta{color:#e5e7eb;font-weight:700}
    .app-badge{
      display:inline-flex;align-items:center;gap:.5rem;
      background:var(--marvel);color:#fff;padding:.375rem .75rem;border-radius:.75rem;
      font-weight:800;letter-spacing:.02em;box-shadow:0 10px 25px rgba(237,29,36,.35)
    }

    /* Botones base */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.4rem;
      padding:.55rem .9rem;border-radius:.75rem;font-weight:700;letter-spacing:.01em;
      box-shadow:0 10px 25px rgba(0,0,0,.25);
      transition:transform .15s ease,box-shadow .15s ease,background-color .15s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:0 18px 30px rgba(0,0,0,.35)}
    .btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:none;transform:none}
    .btn-primary{background-color:var(--marvel);color:#fff}
    .btn-primary:hover{background-color:#c5161c}
    .btn-secondary{background-color:#374151;color:#f8fafc}
    .btn-secondary:hover{background-color:#4b5563}
    .btn-danger{background-color:#b91c1c;color:#f8fafc}
    .btn-danger:hover{background-color:#991b1b}
    .btn-link{color:#f59e0b;font-weight:600}
    .btn-link:hover{color:#fbbf24;text-decoration:underline}

    /* Tarjetas y secciones */
    .card{background-color:rgba(30,41,59,.9);border:1px solid #334155}
    .section-lined{border-top: var(--line-w) solid var(--marvel);}

    /* Placeholder portada */
    .cover-ph{height:12rem;display:flex;align-items:center;justify-content:center;
      background:linear-gradient(135deg, rgba(237,29,36,.85), rgba(124,10,15,.7), #0b0d17);
    }

    /* Mensajes */
    .msg-hidden{height:1.25rem}
  </style>
</head>
<body class="text-gray-200 min-h-screen bg-[#0b0d17]">

  <!-- HERO / HEADER -->
  <header class="app-hero">
    <div class="app-hero__inner">
      <div class="flex items-center justify-between">
        <h1 class="app-hero__title">Mis √Ålbumes</h1>
        <!-- Bot√≥n Inicio eliminado -->
      </div>
      <div class="flex items-center gap-3">
        <span class="app-badge">Clean&nbsp;Marvel&nbsp;Album</span>
        <p class="app-hero__meta">Crea y organiza tus colecciones</p>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto py-8 px-4 space-y-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- ASIDE IZQUIERDA: Crear √Ålbum -->
      <aside class="lg:col-span-1 self-start space-y-6">
        <section class="card section-lined rounded-2xl p-6 shadow-xl">
          <h2 class="text-3xl text-white mb-4">Crear √Ålbum</h2>
          <form id="album-form" class="space-y-4">
            <input id="album-name" class="w-full px-4 py-3 rounded-lg bg-slate-700 border border-slate-600 focus:border-[var(--marvel)] focus:ring-0 focus:outline-none text-white" type="text" placeholder="Nombre del nuevo √°lbum" required>
            <div class="grid grid-cols-1 gap-4">
              <label class="space-y-2 text-sm font-semibold text-gray-300">
                <span>Portada (URL)</span>
                <input id="album-cover-url" class="w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:border-[var(--marvel)] focus:ring-0 focus:outline-none text-white" type="url" placeholder="https://example.com/imagen.jpg">
              </label>
              <label class="space-y-2 text-sm font-semibold text-gray-300">
                <span>Subir portada</span>
                <input id="album-cover-file" class="w-full text-sm text-gray-200 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[var(--marvel)] file:text-white hover:file:bg-red-700 cursor-pointer" type="file" accept="image/png,image/jpeg,image/webp">
              </label>
            </div>
            <button class="btn btn-primary w-full" type="submit">Crear √Ålbum</button>
          </form>
          <p id="album-message" class="text-sm mt-4 hidden msg-hidden"></p>
        </section>

        <!-- ACTIVIDAD: solo reciente con navegaci√≥n (igual que heroes) -->
        <section class="card section-lined rounded-2xl p-6 shadow-xl">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-3">
            <h2 class="text-3xl text-white">üîî Actividad</h2>
            <div class="flex items-center gap-2">
              <button id="album-activity-prev" class="btn btn-secondary text-xs">‚üµ Anterior</button>
              <button id="album-activity-next" class="btn btn-secondary text-xs">Siguiente ‚ü∂</button>
              <button id="clear-album-activity" class="btn btn-danger text-xs">Limpiar</button>
            </div>
          </div>

          <div id="album-activity-empty" class="bg-slate-900/70 border border-slate-700 rounded-xl p-4 text-sm text-gray-300 italic">
            No hay actividad registrada.
          </div>

          <div id="album-activity-view" class="hidden bg-slate-900/80 border border-slate-700 rounded-xl p-4 space-y-2">
            <div class="flex items-center justify-between">
              <span id="album-activity-tag" class="inline-flex items-center px-2 py-1 rounded-md text-[0.65rem] font-black uppercase tracking-[0.18em] border">‚Äî</span>
              <div class="flex items-center gap-2 text-xs text-gray-400">
                <time id="album-activity-date" class="font-mono text-amber-300/80">‚Äî</time>
                <span id="album-activity-counter">0/0</span>
              </div>
            </div>
            <p id="album-activity-title" class="text-sm text-gray-100 leading-tight">‚Äî</p>
          </div>
        </section>
      </aside>

      <!-- MAIN DERECHA: Mis √Ålbumes -->
      <main class="lg:col-span-2 space-y-8">
        <section class="card section-lined rounded-2xl p-6 shadow-xl">
          <!-- Encabezado: contador + filtros + acciones -->
          <div class="mb-4 flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
            <div class="flex items-center gap-3">
              <h2 class="text-3xl text-white">Mis √Ålbumes</h2>
              <span id="albums-counter" class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-bold bg-slate-700 text-gray-100 border border-slate-600">
                0 √°lbumes
              </span>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-4 gap-2 w-full sm:w-auto">
              <div class="sm:col-span-2">
                <label class="block text-xs text-gray-400 mb-1">Buscar (por nombre)</label>
                <input id="filter-q" type="search" placeholder="Ej: vengadores, 2025‚Ä¶"
                  class="w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:border-[var(--marvel)] focus:ring-0 focus:outline-none text-white"/>
              </div>
              <div>
                <label class="block text-xs text-gray-400 mb-1">Ordenar</label>
                <select id="filter-order"
                  class="w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:border-[var(--marvel)] focus:ring-0 focus:outline-none text-white">
                  <option value="recent">Recientes</option>
                  <option value="az">A ‚Üí Z</option>
                  <option value="za">Z ‚Üí A</option>
                </select>
              </div>
              <button id="refresh-albums" class="btn btn-secondary text-sm self-end">üîÑ Refrescar</button>
            </div>
          </div>

          <div id="albums-grid" class="grid gap-5 sm:grid-cols-2 xl:grid-cols-3"></div>
        </section>
      </main>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="mt-10 border-t-[var(--line-w)] border-t-[var(--marvel)]/80 text-center text-xs text-gray-400 py-6">
    ¬© creawebes 2025
  </footer>

  <script>
  (() => {
    // Refs
    const albumForm = document.getElementById('album-form');
    const albumNameInput = document.getElementById('album-name');
    const albumCoverUrlInput = document.getElementById('album-cover-url');
    const albumCoverFileInput = document.getElementById('album-cover-file');
    const albumMessage = document.getElementById('album-message');
    const albumsGrid = document.getElementById('albums-grid');
    const refreshButton = document.getElementById('refresh-albums');

    // Filtros
    const filterInput = document.getElementById('filter-q');
    const orderSelect = document.getElementById('filter-order');
    const albumsCounter = document.getElementById('albums-counter');

    // Actividad (una sola visible + navegaci√≥n)
    const activityEmpty = document.getElementById('album-activity-empty');
    const activityView  = document.getElementById('album-activity-view');
    const clearActivityButton = document.getElementById('clear-album-activity');
    const activityPrevBtn = document.getElementById('album-activity-prev');
    const activityNextBtn = document.getElementById('album-activity-next');
    const tagEl   = document.getElementById('album-activity-tag');
    const dateEl  = document.getElementById('album-activity-date');
    const countEl = document.getElementById('album-activity-counter');
    const titleEl = document.getElementById('album-activity-title');

    // Estado
    let albumsAll = [];
    let albumsFiltered = [];
    let activityLog = [];
    let activityIndex = 0; // 0 = m√°s reciente

    const ALBUM_PLACEHOLDER_CLASSES = 'cover-ph text-white text-2xl font-bold px-4 text-center';
    const ACTIVITY_STORAGE_KEY = 'clean-marvel:albums:activity-log';
    const ACTIVITY_COLORS = {
      CREADO: 'text-emerald-400 border-emerald-500/40',
      EDITADO: 'text-sky-400 border-sky-500/40',
      ELIMINADO: 'text-rose-400 border-rose-500/40'
    };
    const albumEventBus = new EventTarget();
    const activityDateFormatter = typeof Intl !== 'undefined'
      ? new Intl.DateTimeFormat('es-ES', { dateStyle: 'short', timeStyle: 'short' })
      : null;

    // Utils
    function showMessage(element, message, isError = false) {
      element.textContent = message;
      element.classList.remove('hidden');
      element.classList.toggle('text-green-400', !isError);
      element.classList.toggle('text-red-500', isError);
      setTimeout(() => element.classList.add('hidden'), 4000);
    }
    function clearFileInput(input) { input.value = ''; }
    function debounce(fn, ms=200){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    function normalize(s){
      return (s ?? '').toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
    }

    function getAlbumId(raw){
      if (!raw || typeof raw !== 'object') return null;
      return raw.albumId ?? raw.album_id ?? raw.id ?? raw.uuid ?? raw.identifier ?? null;
    }
    function withAlbumId(raw){
      if (!raw || typeof raw !== 'object') return raw;
      const id = getAlbumId(raw);
      if (id == null || raw.albumId === id) return raw;
      return { ...raw, albumId: id };
    }

    // ====== Activity: persistencia y render de 1 sola entrada ======
    function loadActivityFromStorage() {
      if (typeof window === 'undefined' || !window.localStorage) return [];
      try {
        const raw = window.localStorage.getItem(ACTIVITY_STORAGE_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed.slice(0, 100) : [];
      } catch (_) {
        return [];
      }
    }
    function persistActivity() {
      if (typeof window === 'undefined' || !window.localStorage) return;
      try {
        window.localStorage.setItem(ACTIVITY_STORAGE_KEY, JSON.stringify(activityLog));
      } catch (_) { /* ignorar */ }
    }
    function formatActivityTimestamp(timestamp) {
      if (!timestamp) return '‚Äî';
      try {
        const date = new Date(timestamp);
        if (Number.isNaN(date.getTime())) return '‚Äî';
        return activityDateFormatter ? activityDateFormatter.format(date) : date.toLocaleString();
      } catch (_) {
        return '‚Äî';
      }
    }
    function extractAlbumTitle(detail) {
      if (!detail) return '√Ålbum sin t√≠tulo';
      if (typeof detail === 'string') return detail || '√Ålbum sin t√≠tulo';
      if (detail.album && typeof detail === 'object') {
        return extractAlbumTitle(detail.album);
      }
      return detail.nombre || detail.name || detail.title || detail.albumName || '√Ålbum sin t√≠tulo';
    }

    function appendActivity(action, detail) {
      const entry = {
        action,
        title: extractAlbumTitle(detail),
        timestamp: new Date().toISOString()
      };
      activityLog = [entry, ...activityLog].slice(0, 100);
      persistActivity();
      activityIndex = 0; // siempre mostrar la m√°s reciente
      renderActivityView();
    }

    function renderActivityView() {
      const total = activityLog.length;
      if (total === 0) {
        activityEmpty.classList.remove('hidden');
        activityView.classList.add('hidden');
        activityPrevBtn.disabled = true;
        activityNextBtn.disabled = true;
        return;
      }
      if (activityIndex < 0) activityIndex = 0;
      if (activityIndex > total - 1) activityIndex = total - 1;

      const entry = activityLog[activityIndex];

      // tag + color
      tagEl.textContent = entry.action;
      tagEl.className = [
        'inline-flex items-center px-2 py-1 rounded-md text-[0.65rem] font-black uppercase tracking-[0.18em] border',
        ACTIVITY_COLORS[entry.action] || 'text-gray-200 border-slate-600'
      ].join(' ');

      dateEl.textContent = formatActivityTimestamp(entry.timestamp);
      titleEl.textContent = entry.title;
      countEl.textContent = `${activityIndex + 1}/${total}`;

      activityEmpty.classList.add('hidden');
      activityView.classList.remove('hidden');

      activityPrevBtn.disabled = (activityIndex === 0);
      activityNextBtn.disabled = (activityIndex >= total - 1);
    }

    // Controles Anterior / Siguiente
    activityPrevBtn.addEventListener('click', () => {
      activityIndex = Math.max(0, activityIndex - 1);
      renderActivityView();
    });
    activityNextBtn.addEventListener('click', () => {
      activityIndex = Math.min(activityLog.length - 1, activityIndex + 1);
      renderActivityView();
    });

    // Carga inicial de actividad
    activityLog = loadActivityFromStorage();
    renderActivityView();

    // ====== Subir portada (archivo)
    async function uploadAlbumCover(albumId, file) {
      const formData = new FormData();
      formData.append('file', file);
      try {
        const response = await fetch(`/albums/${albumId}/cover`, { method: 'POST', body: formData });
        const payload = await response.json();
        if (!response.ok || payload.estado !== '√©xito') {
          return { ok: false, message: payload.message || 'No se pudo subir la portada.' };
        }
        return { ok: true, datos: payload.datos };
      } catch (error) {
        return { ok: false, message: error.message };
      }
    }

    // ====== Carga de √°lbumes
    async function fetchAlbums() {
      try {
        const response = await fetch('/albums');
        if (!response.ok) throw new Error('Error en la red al cargar √°lbumes.');
        const payload = await response.json();
        if (payload.estado !== '√©xito') throw new Error(payload.message || 'No se pudieron cargar los √°lbumes.');
        const albums = Array.isArray(payload.datos) ? payload.datos.map(withAlbumId) : [];
        albumsAll = albums;
        applyFilters();
      } catch (error) {
        albumsAll = [];
        applyFilters();
        showMessage(albumMessage, error.message, true);
      }
    }

    // ====== Filtro + orden + render
    function applyFilters(){
      const q = normalize(filterInput?.value || '');

      albumsFiltered = albumsAll.filter(a => {
        if (!q) return true;
        return normalize(a.nombre).includes(q);
      });

      const ord = orderSelect?.value || 'recent';
      albumsFiltered.sort((a,b)=>{
        if (ord === 'recent') {
          const ka = a.updatedAt ?? a.createdAt ?? a.albumId ?? 0;
          const kb = b.updatedAt ?? b.createdAt ?? b.albumId ?? 0;
          return (kb > ka) ? 1 : (kb < ka) ? -1 : 0;
        }
        const an = (a.nombre||'').toLowerCase();
        const bn = (b.nombre||'').toLowerCase();
        if (ord === 'za') return an < bn ? 1 : an > bn ? -1 : 0;
        return an > bn ? 1 : an < bn ? -1 : 0;
      });

      renderAlbums(albumsFiltered);
      const total = albumsAll.length;
      const visib = albumsFiltered.length;
      if (albumsCounter){
        albumsCounter.textContent = total === visib ? `${visib} √°lbumes` : `${visib}/${total} √°lbumes`;
      }
    }

    function renderAlbums(albums) {
      if (!albums.length) {
        albumsGrid.innerHTML = '<p class="text-gray-400 col-span-full text-center py-10 italic">No hay √°lbumes. ¬°Crea el primero!</p>';
        return;
      }
      albumsGrid.innerHTML = '';
      albums.forEach((album) => {
        albumsGrid.appendChild(buildAlbumCard(album));
      });
    }

    // ====== Tarjeta de √°lbum (sin bot√≥n "Ver H√©roes"; la tarjeta navega)
    function buildAlbumCard(album) {
      const normalizedAlbum = withAlbumId(album);
      const albumId = getAlbumId(normalizedAlbum);

      function goToAlbum() {
        if (!albumId) {
          showMessage(albumMessage, 'No se encontr√≥ el identificador del √°lbum.', true);
          return;
        }
        const params = new URLSearchParams({ albumId, albumName: normalizedAlbum.nombre });
        window.location.href = `/heroes.html?${params.toString()}`;
      }

      const card = document.createElement('article');
      card.className = 'bg-slate-800 rounded-2xl overflow-hidden border border-slate-700 hover:border-[var(--marvel)] transition-transform duration-300 flex flex-col transform hover:-translate-y-1 shadow-lg cursor-pointer';
      card.setAttribute('role', 'button');
      card.setAttribute('tabindex', '0');
      card.setAttribute('aria-label', `Abrir √°lbum ${normalizedAlbum.nombre}`);

      // Navegaci√≥n: click / Enter / Space
      card.addEventListener('click', (e) => {
        if (e.target.closest('button')) return; // no navegar si se clickea un bot√≥n
        goToAlbum();
      });
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          goToAlbum();
        }
      });

      // Portada
      const coverWrapper = document.createElement('div');
      if (normalizedAlbum.coverImage) {
        const coverImg = document.createElement('img');
        coverImg.src = normalizedAlbum.coverImage;
        coverImg.alt = `Portada del √°lbum ${normalizedAlbum.nombre}`;
        coverImg.className = 'w-full h-48 object-cover';
        coverWrapper.appendChild(coverImg);
      } else {
        const fallback = document.createElement('div');
        fallback.className = ALBUM_PLACEHOLDER_CLASSES;
        fallback.textContent = normalizedAlbum.nombre;
        coverWrapper.appendChild(fallback);
      }
      card.appendChild(coverWrapper);

      // Contenido
      const content = document.createElement('div');
      content.className = 'p-4 space-y-2';
      const title = document.createElement('h3');
      title.className = 'text-2xl text-white';
      title.textContent = normalizedAlbum.nombre;

      const meta = document.createElement('p');
      meta.className = 'text-xs text-gray-400';
      const createdAt = normalizedAlbum.createdAt ? new Date(normalizedAlbum.createdAt).toLocaleDateString() : '‚Äî';
      const updatedAt = normalizedAlbum.updatedAt ? new Date(normalizedAlbum.updatedAt).toLocaleDateString() : createdAt;
      meta.textContent = `Creado: ${createdAt} ¬∑ Actualizado: ${updatedAt}`;

      content.append(title, meta);
      card.appendChild(content);

      // Acciones (solo Editar / Eliminar)
      const actions = document.createElement('div');
      actions.className = 'flex flex-wrap items-center gap-2 p-4 pt-0';

      const editButton = document.createElement('button');
      editButton.type = 'button';
      editButton.className = 'btn btn-secondary flex-1 min-w-[140px]';
      editButton.textContent = 'Editar';
      editButton.addEventListener('click', (e) => e.stopPropagation());

      const deleteButton = document.createElement('button');
      deleteButton.type = 'button';
      deleteButton.className = 'btn btn-danger flex-1 min-w-[140px]';
      deleteButton.textContent = 'Eliminar';
      deleteButton.dataset.albumId = albumId ?? '';
      deleteButton.dataset.albumName = normalizedAlbum.nombre;
      deleteButton.addEventListener('click', (e) => e.stopPropagation());

      actions.append(editButton, deleteButton);
      card.appendChild(actions);

      // Editor
      const editSection = buildEditSection(normalizedAlbum);
      editSection.section.addEventListener('click', (e) => e.stopPropagation());
      card.appendChild(editSection.section);

      // Listeners del editor
      editButton.addEventListener('click', () => {
        const hidden = editSection.section.classList.contains('hidden');
        if (hidden) {
          editSection.populate(album);
          editSection.section.classList.remove('hidden');
        } else {
          editSection.section.classList.add('hidden');
        }
      });

      // Eliminar
      deleteButton.addEventListener('click', async () => {
        const albumName = deleteButton.dataset.albumName || normalizedAlbum.nombre;
        if (!confirm(`¬øSeguro que quieres eliminar el √°lbum "${albumName}" y todos sus h√©roes?`)) return;
        const albumIdForDelete = deleteButton.dataset.albumId || getAlbumId(normalizedAlbum);
        if (!albumIdForDelete) {
          showMessage(albumMessage, 'No se pudo determinar el ID del √°lbum.', true);
          return;
        }
        try {
          const response = await fetch(`/albums/${albumIdForDelete}`, { method: 'DELETE' });
          const payload = await response.json();
          if (!response.ok || payload.estado !== '√©xito') {
            throw new Error(payload.message || payload.datos?.message || 'No se pudo eliminar el √°lbum.');
          }
          const successMessage = payload.datos?.message || '√Ålbum eliminado.';
          showMessage(albumMessage, successMessage);
          albumEventBus.dispatchEvent(new CustomEvent('album:deleted', {
            detail: { nombre: albumName, albumId: albumIdForDelete }
          }));
          fetchAlbums();
        } catch (error) {
          showMessage(albumMessage, error.message, true);
        }
      });

      return card;
    }

    // ====== Editor de √°lbum
    function buildEditSection(initialAlbum) {
      let currentAlbum = withAlbumId(initialAlbum);

      const section = document.createElement('div');
      section.className = 'hidden border border-slate-700 bg-slate-900/70 rounded-xl p-4 space-y-4 mt-4';

      const form = document.createElement('form');
      form.className = 'space-y-4';

      const nameLabel = document.createElement('label');
      nameLabel.className = 'space-y-2 text-sm font-semibold text-gray-300';
      const nameSpan = document.createElement('span');
      nameSpan.textContent = 'Nombre del √°lbum';
      const nameInput = document.createElement('input');
      nameInput.className = 'w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:border-[var(--marvel)] focus:ring-0 focus:outline-none text-white';
      nameInput.required = true;
      nameLabel.append(nameSpan, nameInput);

      const coverUrlLabel = document.createElement('label');
      coverUrlLabel.className = 'space-y-2 text-sm font-semibold text-gray-300';
      const coverUrlSpan = document.createElement('span');
      coverUrlSpan.textContent = 'Portada (URL)';
      const coverUrlInput = document.createElement('input');
      coverUrlInput.className = 'w-full px-3 py-2 rounded-lg bg-slate-700 border border-slate-600 focus:border-[var(--marvel)] focus:ring-0 focus:outline-none text-white';
      coverUrlInput.type = 'url';
      coverUrlLabel.append(coverUrlSpan, coverUrlInput);

      const coverFileLabel = document.createElement('label');
      coverFileLabel.className = 'space-y-2 text-sm font-semibold text-gray-300';
      const coverFileSpan = document.createElement('span');
      coverFileSpan.textContent = 'Subir portada';
      const coverFileInput = document.createElement('input');
      coverFileInput.type = 'file';
      coverFileInput.accept = 'image/png,image/jpeg,image/webp';
      coverFileInput.className = 'w-full text-sm text-gray-200 file:mr-3 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[var(--marvel)] file:text-white hover:file:bg-red-700 cursor-pointer';
      coverFileLabel.append(coverFileSpan, coverFileInput);

      const buttonsRow = document.createElement('div');
      buttonsRow.className = 'flex flex-wrap items-center gap-2';
      const saveButton = document.createElement('button');
      saveButton.type = 'submit';
      saveButton.className = 'btn btn-primary flex-1 min-w-[140px]';
      saveButton.textContent = 'Guardar cambios';
      const cancelButton = document.createElement('button');
      cancelButton.type = 'button';
      cancelButton.className = 'btn btn-secondary flex-1 min-w-[140px]';
      cancelButton.textContent = 'Cancelar';
      buttonsRow.append(saveButton, cancelButton);

      const message = document.createElement('p');
      message.className = 'text-sm hidden';

      form.append(nameLabel, coverUrlLabel, coverFileLabel, buttonsRow, message);
      section.appendChild(form);

      cancelButton.addEventListener('click', () => {
        section.classList.add('hidden');
        coverUrlInput.value = currentAlbum.coverImage ?? '';
        clearFileInput(coverFileInput);
        message.classList.add('hidden');
      });

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const nuevoNombre = nameInput.value.trim();
        if (!nuevoNombre) {
          showMessage(message, 'El nombre no puede estar vac√≠o.', true);
          return;
        }

        const rawCoverUrl = coverUrlInput.value;
        const trimmedCoverUrl = rawCoverUrl.trim();
        const currentCover = currentAlbum.coverImage ?? '';
        const coverChanged = trimmedCoverUrl !== currentCover;
        const payload = { nombre: nuevoNombre };
        if (coverChanged || rawCoverUrl === '') {
          payload.coverImage = rawCoverUrl;
        }

        const file = coverFileInput.files[0] ?? null;

        try {
          const response = await fetch(`/albums/${currentAlbum.albumId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const result = await response.json();
          if (!response.ok || result.estado !== '√©xito') {
            throw new Error(result.message || 'No se pudo actualizar el √°lbum.');
          }

          const updatedAlbum = withAlbumId({
            albumId: currentAlbum.albumId,
            nombre: result.datos.nombre ?? nuevoNombre,
            coverImage: result.datos.coverImage ?? (payload.coverImage !== undefined ? (trimmedCoverUrl || null) : (currentAlbum.coverImage ?? null)),
            createdAt: result.datos.createdAt ?? currentAlbum.createdAt,
            updatedAt: result.datos.updatedAt ?? currentAlbum.updatedAt,
          });
          currentAlbum = updatedAlbum;

          if (file) {
            const uploadOutcome = await uploadAlbumCover(currentAlbum.albumId, file);
            if (!uploadOutcome.ok) throw new Error(uploadOutcome.message || 'No se pudo subir la portada.');
            currentAlbum.coverImage = uploadOutcome.datos?.coverImage ?? currentAlbum.coverImage;
          }

          albumEventBus.dispatchEvent(new CustomEvent('album:updated', {
            detail: { album: currentAlbum, nombre: currentAlbum.nombre }
          }));

          showMessage(albumMessage, '√Ålbum actualizado correctamente.');
          section.classList.add('hidden');
          coverUrlInput.value = currentAlbum.coverImage ?? '';
          clearFileInput(coverFileInput);
          message.classList.add('hidden');
          fetchAlbums();
        } catch (error) {
          showMessage(message, error.message, true);
        }
      });

      const populate = (album) => {
        currentAlbum = withAlbumId(album);
        nameInput.value = currentAlbum.nombre;
        coverUrlInput.value = currentAlbum.coverImage ?? '';
        clearFileInput(coverFileInput);
        message.classList.add('hidden');
      };

      populate(initialAlbum);
      return { section, populate };
    }

    // ====== Crear √°lbum
    albumForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const nombre = albumNameInput.value.trim();
      if (!nombre) {
        showMessage(albumMessage, 'El nombre del √°lbum no puede estar vac√≠o.', true);
        return;
      }

      const file = albumCoverFileInput.files[0] ?? null;
      const coverUrl = albumCoverUrlInput.value.trim();

      const payload = { nombre };
      if (!file && coverUrl) payload.coverImage = coverUrl;

      let albumCreated = false;

      try {
        const response = await fetch('/albums', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (!response.ok || result.estado !== '√©xito') {
          throw new Error(result.message || 'No se pudo crear el √°lbum.');
        }

        let responseData = result?.datos && typeof result.datos === 'object' ? { ...result.datos } : {};
        responseData = withAlbumId(responseData);
        albumCreated = true;
        const albumId = getAlbumId(responseData);
        if (!albumId) {
          throw new Error('No se recibi√≥ el identificador del √°lbum creado.');
        }

        if (file) {
          const uploadOutcome = await uploadAlbumCover(albumId, file);
          if (!uploadOutcome.ok) throw new Error(uploadOutcome.message || 'No se pudo subir la portada.');
          responseData.coverImage = uploadOutcome.datos?.coverImage ?? responseData.coverImage;
        }

        const createdName = responseData.nombre ?  ` "${responseData.nombre}"` : '';
        showMessage(albumMessage, `√Ålbum${createdName} creado.`);
        albumForm.reset();
        clearFileInput(albumCoverFileInput);

        albumEventBus.dispatchEvent(new CustomEvent('album:created', {
          detail: { album: responseData, nombre: responseData.nombre ?? nombre }
        }));

        fetchAlbums();
      } catch (error) {
        showMessage(albumMessage, error.message, true);
        if (albumCreated) fetchAlbums();
      }
    });

    // ====== Hooks actividad
    albumEventBus.addEventListener('album:created', (event) => appendActivity('CREADO', event?.detail));
    albumEventBus.addEventListener('album:updated', (event) => appendActivity('EDITADO', event?.detail));
    albumEventBus.addEventListener('album:deleted', (event) => appendActivity('ELIMINADO', event?.detail));

    clearActivityButton?.addEventListener('click', () => {
      if (!activityLog.length) return;
      activityLog = [];
      persistActivity();
      renderActivityView();
      showMessage(albumMessage, 'Registro de actividad vac√≠o.');
    });

    // ====== Filtros/acciones
    filterInput?.addEventListener('input', debounce(applyFilters, 200));
    orderSelect?.addEventListener('change', applyFilters);
    refreshButton.addEventListener('click', fetchAlbums);

    // Init
    fetchAlbums();
  })();
  </script>
</body>
</html>
